- id: executor_submit
  structure:
    modules:
      dummy.py: |
        from cellophane import pre_hook, runner, Executor, executors
        from uuid import UUID

        @pre_hook()
        def runner_a(logger, samples, executor, **_):
            logger.info(f"HOOK - {executor.name=}")
            logger.info(f"HOOK - {executors.EXECUTOR.name=}")
            uuid_ = UUID("deadbeefdeadbeefdeadbeefdeadbeef")
            executor.submit("ping localhost -c 1", wait=True, name="HOOK", uuid=uuid_)
            return samples

        @runner()
        def runner_b(logger, samples, executor, **_):
            logger.info(f"RUNNER - {executor.name=}")
            logger.info(f"RUNNER - {executors.EXECUTOR.name=}")
            uuid_ = UUID("cafebabecafebabecafebabecafebabe")
            executor.submit("ping localhost -c 1", wait=True, name="RUNNER", uuid=uuid_)
            return samples

    samples.yaml: |
      - id: a
        files:
        - input/a.txt
    input:
      a.txt: "INPUT_A"

  args:
    --samples_file: samples.yaml
    --executor_name: mock
    --workdir: out

  logs:
  - HOOK - executor.name='mock'
  - HOOK - executors.EXECUTOR.name='mock'
  - RUNNER - executor.name='mock'
  - RUNNER - executors.EXECUTOR.name='mock'
  - MockExecutor called with name='RUNNER'
  - MockExecutor called with name='HOOK'
  - cmdline=ping localhost -c 1
  - uuid=deadbeef-dead-beef-dead-beefdeadbeef
  - uuid=cafebabe-cafe-babe-cafe-babecafebabe
  - workdir=out/deadbeefdeadbeefdeadbeefdeadbeef
  - workdir=out/cafebabecafebabecafebabecafebabe
  - os_env=True
  - cpus=1
  - memory=2000000000


- id: executor_subprocess
  structure:
    modules:
      dummy.py: |
        from cellophane import pre_hook
        from uuid import UUID

        @pre_hook()
        def runner_a(logger, samples, executor, config, **_):
            uuid_ = UUID("deadbeefdeadbeefdeadbeefdeadbeef")
            result, uuid = executor.submit("ping localhost -c 1", wait=True, uuid=uuid_)

  args:
    --workdir: out

  logs:
  - Using subprocess executor
  - exited with code 0
  - "Job completed: deadbeef-dead-beef-dead-beefdeadbeef"

- id: executor_subprocess_terminate

  structure:
    modules:
      dummy.py: |
        from cellophane import pre_hook
        from time import sleep
        from uuid import UUID

        @pre_hook()
        def runner_a(logger, samples, executor, config, **_):
            uuid_ = UUID("deadbeefdeadbeefdeadbeefdeadbeef")
            executor.submit("ping localhost -c 2", uuid=uuid_)
            executor.terminate()
            executor.wait()
  args:
    --workdir: out

  logs:
  - Started process
  - Terminating job with uuid deadbeef-dead-beef-dead-beefdeadbeef
  - Terminating process
  - exited with code -15
  - "Job failed: deadbeef-dead-beef-dead-beefdeadbeef"

- id: executor_conda
  structure:
    modules:
      dummy.py: |
        from cellophane import pre_hook, Executor
        from pathlib import Path
        from uuid import UUID

        @pre_hook()
        def runner_a(logger, samples, executor, config, **_):
            uuid_ = UUID("deadbeefdeadbeefdeadbeefdeadbeef")
            result, uuid = executor.submit(
              "ping localhost -c 1",
              wait=True,
              conda_spec={
                "dependencies": [
                  "python >=3.8,<3.9"
                ]
              },
              uuid=uuid_
            )

  args:
    --executor_name: mock
    --workdir: out

  logs:
  - bootstrap_micromamba.sh ping localhost -c 1
  - env._CONDA_ENV_SPEC=conda/deadbeefdeadbeefdeadbeefdeadbeef.environment.yaml
  - env._CONDA_ENV_NAME=deadbeefdeadbeefdeadbeefdeadbeef
